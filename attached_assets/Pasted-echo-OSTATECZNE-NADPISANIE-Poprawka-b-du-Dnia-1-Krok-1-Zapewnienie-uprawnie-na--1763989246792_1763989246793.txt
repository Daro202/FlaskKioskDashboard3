echo "--- OSTATECZNE NADPISANIE (Poprawka bdu Dnia 1) ---"

# Krok 1: Zapewnienie uprawnie (na wszelki wypadek)
mkdir -p /srv/kiosk-app/static/images
touch /srv/kiosk-app/kiosk.db
chmod -R 755 /srv/kiosk-app/static
chmod 666 /srv/kiosk-app/kiosk.db

# Krok 2: Nadpisanie pliku czystym kodem (z POPRAWK Dnia 1)
SERVICE_FILE="/srv/kiosk-app/app.py"
cat << 'EOF' | sudo tee ${SERVICE_FILE}
# -*- coding: utf-8 -*-
"""
Firmowy Kiosk - Aplikacja Flask do wyswietlania dashboardow
Autor: Replit Agent
Data: 2025-10-31
"""

import os
import json
import sqlite3
import secrets
from datetime import datetime
from flask import Flask, render_template, request, jsonify, session, redirect, url_for
from werkzeug.utils import secure_filename
import pandas as pd
from waitress import serve

# Konfiguracja aplikacji Flask
app = Flask(__name__)

# Bezpieczny sekret sesji
app.secret_key = secrets.token_hex(32)
print("锔  UWAGA: U偶ywany jest tymczasowy klucz sesji!")

# Ustawienie cie偶ek wzgldem pliku app.py
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
app.config['UPLOAD_FOLDER'] = os.path.join(BASE_DIR, 'static/images')
app.config['DB_PATH'] = os.path.join(BASE_DIR, 'kiosk.db')
EXCEL_PATH = os.path.join(BASE_DIR, "Export.xlsx")

app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # Max 16MB upload

# Dozwolone rozszerzenia plik贸w
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'}

# ==================== BAZA DANYCH ====================

def init_db():
    """Inicjalizacja bazy danych SQLite"""
    conn = sqlite3.connect(app.config['DB_PATH'])
    c = conn.cursor()
    
    # Tabela z ustawieniami og贸lnymi
    c.execute('''CREATE TABLE IF NOT EXISTS settings
                 (key TEXT PRIMARY KEY, value TEXT)''')
    
    # Tabela z inspiracjami
    c.execute('''CREATE TABLE IF NOT EXISTS inspirations
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  title TEXT,
                  description TEXT,
                  image_url TEXT,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    
    # Tabela ze zdjciami (dla pokazu slajd贸w)
    c.execute('''CREATE TABLE IF NOT EXISTS slides
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  filename TEXT,
                  caption TEXT,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    
    # Wstaw domylne ustawienia jeli nie istniej
    c.execute("SELECT COUNT(*) FROM settings")
    if c.fetchone()[0] == 0:
        default_settings = [
            ('header_title', 'Dashboard Inspiracji i Wynik贸w'),
            ('footer_note', 'Stora Enso - Innowacje dla Przyszoci'),
            ('about_text', 'Nasz zesp贸 stale poszukuje nowych rozwiza i inspiracji.')
        ]
        c.executemany("INSERT INTO settings (key, value) VALUES (?, ?)", default_settings)
        
        # Dodaj przykadowe inspiracje
        example_inspirations = [
            ('Zielona Energia', 'Inwestujemy w odnawialne 藕r贸da energii, aby zmniejszy nasz lad wglowy.', '/static/images/placeholder1.jpg'),
            ('Cyfrowa Transformacja', 'Automatyzacja proces贸w i wykorzystanie AI w produkcji.', '/static/images/placeholder2.jpg'),
            ('Ekologiczne Opakowania', 'Rozw贸j biodegradowalnych materia贸w opakowaniowych.', '/static/images/placeholder3.jpg')
        ]
        c.executemany("INSERT INTO inspirations (title, description, image_url) VALUES (?, ?, ?)", 
                       example_inspirations)
    
    conn.commit()
    conn.close()
    print("?? Baza danych SQLite zainicjalizowana.")

def get_db_conn():
    """Pomocnik do czenia si z baz"""
    return sqlite3.connect(app.config['DB_PATH'])

def get_setting(key):
    """Pobierz ustawienie z bazy danych"""
    conn = get_db_conn()
    c = conn.cursor()
    c.execute("SELECT value FROM settings WHERE key=?", (key,))
    result = c.fetchone()
    conn.close()
    return result[0] if result else None

def update_setting(key, value):
    """Aktualizuj ustawienie w bazie danych"""
    conn = get_db_conn()
    c = conn.cursor()
    c.execute("INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)", (key, value))
    conn.commit()
    conn.close()

def get_inspirations():
    """Pobierz wszystkie inspiracje"""
    conn = get_db_conn()
    conn.row_factory = sqlite3.Row
    c = conn.cursor()
    c.execute("SELECT id, title, description, image_url FROM inspirations ORDER BY created_at DESC")
    inspirations = [dict(row) for row in c.fetchall()]
    conn.close()
    return inspirations

def get_slide_images():
    """Pobierz list zdj do pokazu slajd贸w z BAZY DANYCH"""
    conn = get_db_conn()
    conn.row_factory = sqlite3.Row
    c = conn.cursor()
    c.execute("SELECT id, filename, caption FROM slides ORDER BY created_at DESC")
    images = [dict(row) for row in c.fetchall()]
    # Uzupenij URL
    for img in images:
        img['url'] = f'/static/images/{img["filename"]}'
    conn.close()
    
    # Jeli baza jest pusta, zwr贸 placeholdery
    if not images:
        images = [
            {'id': 0, 'url': '/static/images/placeholder1.jpg', 'caption': 'Zielona Energia', 'filename': 'placeholder1.jpg'},
            {'id': 0, 'url': '/static/images/placeholder2.jpg', 'caption': 'Cyfrowa Transformacja', 'filename': 'placeholder2.jpg'},
            {'id': 0, 'url': '/static/images/placeholder3.jpg', 'caption': 'Ekologiczne Opakowania', 'filename': 'placeholder3.jpg'}
        ]
    return images

# ==================== POMOCNICZE FUNKCJE ====================

def allowed_file(filename):
    """Sprawd藕 czy plik ma dozwolone rozszerzenie"""
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def load_config():
    """Wczytaj konfiguracj z pliku config.json"""
    try:
        with open('config.json', 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        # Zwr贸 domyln konfiguracj jeli plik nie istnieje
        return {'admin_pin': '7456', 'rotation_interval': 30, 'refresh_interval': 300}

def get_chart_data():
    """Wczytaj dane z pliku Export.xlsx - dla kompatybilnoci (nie u偶ywane)"""
    return []

def get_chart_data_for_machine(kod='1310', start_day=1):
    """Wczytaj dane dla konkretnej maszyny z Export.xlsx"""
    try:
        # Wczytaj dane z Export.xlsx
        df_long = load_long()
        
        if df_long.empty:
            print("? Bd get_chart_data_for_machine: load_long() zwr贸ci puste dane.")
            return {'series': []}
        
        # Filtruj dane dla wybranej maszyny
        df_maszyna = df_long[df_long['Kod'] == str(kod)].copy()
        
        if df_maszyna.empty:
            print(f"? Brak danych dla maszyny {kod}")
            return {'series': []}
        
        # Pobierz 7 dni od start_day
        end_day = start_day + 6
        
        series_data = []
        kolory_slupki = {'A': '#0ea5e9', 'B': '#FF6B35', 'C': '#6b7280'}
        kolory_linie = {'A': '#0284c7', 'B': '#f97316', 'C': '#4b5563'}
        
        # Supki dla wartoci dziennych (brygady A, B, C)
        for brygada in ['A', 'B', 'C']:
            mask = (df_maszyna['Typ'] == 'Dzienne') & (df_maszyna['Brygada'] == brygada) & \
                   (df_maszyna['Dzien'] >= start_day) & (df_maszyna['Dzien'] <= end_day)
            filtered = df_maszyna[mask].copy().sort_values('Dzien')
            
            if not filtered.empty:
                series_data.append({
                    'type': 'bar',
                    'name': brygada,
                    'x': filtered['Dzien'].tolist(),
                    'y': [round(v, 0) for v in filtered['Wartosc'].tolist()],
                    'color': kolory_slupki.get(brygada, '#999999')
                })
        
        # Linie dla wartoci narastajcych (brygady A, B, C)
        for brygada in ['A', 'B', 'C']:
            mask = (df_maszyna['Typ'] == 'Narastajce') & (df_maszyna['Brygada'] == brygada) & \
                   (df_maszyna['Dzien'] >= start_day) & (df_maszyna['Dzien'] <= end_day)
            filtered = df_maszyna[mask].copy().sort_values('Dzien')
            
            if not filtered.empty:
                series_data.append({
                    'type': 'line',
                    'name': f'Narastajco {brygada}',
                    'x': filtered['Dzien'].tolist(),
                    'y': [round(v, 0) for v in filtered['Wartosc'].tolist()],
                    'color': kolory_linie.get(brygada, '#666666')
                })
        
        return {'series': series_data}
        
    except Exception as e:
        print(f"Bd wczytywania danych dla maszyny {kod}: {e}")
        return {'series': []}

def load_long():
    """
    Wczytaj dane z pliku Export.xlsx i przekszta do formy dugiej (long format)
    """
    try:
        # U偶ywamy EXCEL_PATH zamiast 'Export.xlsx'
        df = pd.read_excel(EXCEL_PATH, sheet_name='Export', engine='openpyxl', header=0)
        
        # *** KLUCZOWA POPRAWKA (BD DNIA 1) ***
        # Sprawd藕, czy 'Nazwa' istnieje. Od tego zale偶y indeks startowy dni.
        if 'Nazwa' not in df.columns:
            df['Nazwa'] = ''
            first_day_col_index = 3 # Dni zaczynaj si od kolumny 3 (Typ, Kod, Brygada)
        else:
            first_day_col_index = 4 # Dni zaczynaj si od kolumny 4 (Typ, Kod, Nazwa, Brygada)
            
        id_vars = ['Typ', 'Kod', 'Nazwa', 'Brygada']
        
        # Przekszta nag贸wki dni (kolumny od first_day_col_index) na int
        day_cols = []
        for col in df.columns[first_day_col_index:]: # <-- POPRAWKA
            try:
                day_cols.append(int(col))
            except (ValueError, TypeError):
                pass
        
        # Wybierz tylko kolumny podstawowe + dni jako int
        valid_cols = id_vars + [c for c in df.columns[first_day_col_index:] if c in day_cols or str(c).isdigit()] # <-- POPRAWKA
        df_safe = df[valid_cols].copy()
        
        # Zmie nazwy kolumn dni na int
        col_rename = {}
        for col in df_safe.columns[first_day_col_index:]: # <-- POPRAWKA
            try:
                col_rename[col] = int(col)
            except (ValueError, TypeError):
                pass
        df_safe.rename(columns=col_rename, inplace=True)
        
        # Przekszta do formy dugiej (melt)
        value_vars = [col for col in df_safe.columns if isinstance(col, int) and 1 <= col <= 31]
        
        df_long = pd.melt(
            df_safe,
            id_vars=id_vars,
            value_vars=value_vars,
            var_name='Dzien',
            value_name='Wartosc'
        )
        
        # Usu wiersze z NaN w kolumnie Wartosc
        df_long = df_long.dropna(subset=['Wartosc'])
        
        # Konwertuj typy
        df_long['Typ'] = df_long['Typ'].astype(str)
        df_long['Kod'] = df_long['Kod'].astype(str)
        df_long['Nazwa'] = df_long['Nazwa'].astype(str)
        df_long['Brygada'] = df_long['Brygada'].astype(str)
        df_long['Dzien'] = df_long['Dzien'].astype(int)
        df_long['Wartosc'] = df_long['Wartosc'].astype(float)
        
        print(f"?? Dane (Peny Replit z POPRAWK Dnia 1) wczytane poprawnie: {len(df_long)} wierszy.")
        return df_long
    
    except FileNotFoundError:
        print(f"?? BD KRYTYCZNY: Nie znaleziono pliku {EXCEL_PATH}")
        return pd.DataFrame(columns=['Typ', 'Kod', 'Nazwa', 'Brygada', 'Dzien', 'Wartosc'])
    except Exception as e:
        print(f"Bd wczytywania danych z Export.xlsx (Peny Replit): {e}")
        return pd.DataFrame(columns=['Typ', 'Kod', 'Nazwa', 'Brygada', 'Dzien', 'Wartosc'])

# ==================== TRASY (ROUTES) ====================

@app.route('/')
def index():
    """Strona g贸wna - Dashboard"""
    header_title = get_setting('header_title')
    footer_note = get_setting('footer_note')
    inspirations = get_inspirations()
    
    return render_template('index.html',
                           header_title=header_title,
                           footer_note=footer_note,
                           inspirations=inspirations)

@app.route('/admin', methods=['GET', 'POST'])
def admin():
    """Panel administracyjny"""
    config = load_config()
    
    if request.method == 'POST':
        # Sprawd藕 PIN
        pin = request.form.get('pin')
        if pin == config['admin_pin']:
            session['authenticated'] = True
            return redirect(url_for('admin'))
        else:
            return render_template('admin.html', error='Nieprawidowy PIN!')
    
    # Sprawd藕 czy u偶ytkownik jest zalogowany
    if not session.get('authenticated'):
        return render_template('admin.html', authenticated=False)
    
    # U偶ytkownik zalogowany - poka偶 panel
    header_title = get_setting('header_title')
    footer_note = get_setting('footer_note')
    about_text = get_setting('about_text')
    inspirations = get_inspirations()
    
    return render_template('admin.html',
                           authenticated=True,
                           header_title=header_title,
                           footer_note=footer_note,
                           about_text=about_text,
                           inspirations=inspirations)

@app.route('/admin/logout')
def admin_logout():
    """Wylogowanie z panelu admina"""
    session.pop('authenticated', None)
    return redirect(url_for('admin'))

# ==================== API ENDPOINTS (PENA WERSJA) ====================

@app.route('/api/settings', methods=['POST'])
def update_settings():
    """Aktualizuj ustawienia aplikacji"""
    if not session.get('authenticated'):
        return jsonify({'error': 'Brak autoryzacji'}), 401
    
    data = request.json
    if data and 'header_title' in data:
        update_setting('header_title', data['header_title'])
    if data and 'footer_note' in data:
        update_setting('footer_note', data['footer_note'])
    if data and 'about_text' in data:
        update_setting('about_text', data['about_text'])
    
    return jsonify({'success': True})

@app.route('/api/inspiration', methods=['POST'])
def add_inspiration():
    """Dodaj now inspiracj"""
    if not session.get('authenticated'):
        return jsonify({'error': 'Brak autoryzacji'}), 401
    
    data = request.json or {}
    conn = get_db_conn()
    c = conn.cursor()
    c.execute("INSERT INTO inspirations (title, description, image_url) VALUES (?, ?, ?)",
             (data.get('title', ''), data.get('description', ''), data.get('image_url', '')))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True})

@app.route('/api/inspiration/<int:inspiration_id>', methods=['DELETE'])
def delete_inspiration(inspiration_id):
    """Usu inspiracj"""
    if not session.get('authenticated'):
        return jsonify({'error': 'Brak autoryzacji'}), 401
    
    conn = get_db_conn()
    c = conn.cursor()
    c.execute("DELETE FROM inspirations WHERE id=?", (inspiration_id,))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True})

@app.route('/api/upload', methods=['POST'])
def upload_file():
    """Upload pliku zdjcia"""
    if not session.get('authenticated'):
        return jsonify({'error': 'Brak autoryzacji'}), 401
    
    if 'file' not in request.files:
        return jsonify({'error': 'Brak pliku'}), 400
    
    file = request.files['file']
    if file.filename == '' or file.filename is None:
        return jsonify({'error': 'Nie wybrano pliku'}), 400
    
    if file and file.filename and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        # Dodaj timestamp do nazwy aby unikn konflikt贸w
        name, ext = os.path.splitext(filename)
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"{name}_{timestamp}{ext}"
        
        filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        file.save(filepath)
        
        # Zapisz do bazy danych slides
        conn = get_db_conn()
        c = conn.cursor()
        c.execute("INSERT INTO slides (filename, caption) VALUES (?, ?)", (filename, ''))
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'url': f'/static/images/{filename}',
            'filename': filename
        })
    
    return jsonify({'error': 'Niedozwolony typ pliku'}), 400

@app.route('/api/upload-excel', methods=['POST'])
def upload_excel():
    """Upload pliku Excel (Export.xlsx)"""
    if not session.get('authenticated'):
        return jsonify({'error': 'Brak autoryzacji'}), 401
    
    if 'excel_file' not in request.files:
        return jsonify({'error': 'Brak pliku'}), 400
    
    file = request.files['excel_file']
    if file.filename == '' or file.filename is None:
        return jsonify({'error': 'Nie wybrano pliku'}), 400
    
    # Sprawd藕 czy to plik Excel
    if file and file.filename and (file.filename.endswith('.xlsx') or file.filename.endswith('.xls')):
        # Zapisz jako Export.xlsx (zastp istniejcy)
        filepath = EXCEL_PATH
        file.save(filepath)
        
        return jsonify({
            'success': True,
            'message': 'Plik Export.xlsx zosta zaktualizowany',
            'filename': 'Export.xlsx'
        })
    
    return jsonify({'error': 'Niedozwolony typ pliku - wymagany plik .xlsx lub .xls'}), 400

@app.route('/api/chart-data') 
@app.route('/chart-data')    
def chart_data():
    """Zwr贸 dane do wykres贸w dla konkretnej maszyny"""
    kod = request.args.get('kod', '1310')
    start_day = int(request.args.get('start_day', 1))
    data = get_chart_data_for_machine(kod=kod, start_day=start_day)
    return jsonify(data)

@app.route('/api/machines') 
@app.route('/machines')     
def get_machines():
    """Zwr贸 list dostpnych maszyn z Export.xlsx"""
    try:
        df_long = load_long()
        if df_long.empty:
            return jsonify([])
        
        # Pobierz unikalne maszyny (kod + nazwa)
        maszyny_df = df_long[['Kod', 'Nazwa']].drop_duplicates().sort_values('Kod')
        maszyny = []
        for _, row in maszyny_df.iterrows():
            kod = row['Kod']
            nazwa = row['Nazwa']
            if nazwa and str(nazwa).strip():
                maszyny.append({'kod': kod, 'label': f"{kod} {nazwa}"})
            else:
                maszyny.append({'kod': kod, 'label': kod})
        
        return jsonify(maszyny)
    except Exception as e:
        print(f"Bd pobierania listy maszyn: {e}")
        return jsonify([])

@app.route('/api/slides')
@app.route('/slides')
def slides():
    return jsonify(get_slide_images())

@app.route('/api/inspirations')
@app.route('/inspirations')
def api_inspirations():
    return jsonify(get_inspirations())

@app.route('/api/content')
@app.route('/content')
def get_content():
    """Zwr贸 ca tre dla strony g贸wnej (dla auto-refresh)"""
    return jsonify({
        'header_title': get_setting('header_title'),
        'footer_note': get_setting('footer_note'),
        'about_text': get_setting('about_text'),
        'inspirations': get_inspirations(),
        'chart_data': get_chart_data(),
        'slides': get_slide_images()
    })

# ==================== URUCHOMIENIE APLIKACJI ====================

if __name__ == '__main__':
    # Inicjalizuj baz danych
    init_db()
    
    # Utw贸rz folder na zdjcia jeli nie istnieje
    os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
    
    print("=" * 60)
    print(" Firmowy Kiosk - Aplikacja uruchomiona! (Wersja PENA z Adminem)")
    print("=" * 60)
    print(f" Adres: http://31.97.76.175:80")
    print(f" Panel admina: http://31.97.76.175:80/admin")
    print(" PIN administracyjny: 7456")
    print("=" * 60)
    
    # *** POPRAWKA PORTU DLA SERWERA ***
    serve(app, host='0.0.0.0', port=80, threads=4)
EOF

# Krok 3: Zmiana uprawnie do wykonania
sudo chmod +x /srv/kiosk-app/app.py

# Krok 4: Restart i sprawdzenie
echo "--- Uruchomienie usugi po czystym wklejeniu (POPRAWKA DNIA 1) ---"
sudo systemctl restart kioskapp.service

sleep 2 # Daj 2 sekundy na inicjalizacj bazy

echo "--- Weryfikacja statusu ---"
sudo systemctl status kioskapp.service --no-pager -l